#!/bin/bash

set -eo pipefail

# Currently this only if for the new pipeline, so if we aren't on the new
# pipeline just exit.
if [ ! "$BUILDKITE_PIPELINE_SLUG" == "scionproto2" ]; then
    exit 0
fi

# Now we build the artifact name next, for this we first need TARGET and BUILD,
# see below.
#
# For PRs the target is the pull request, otherwise it is the branch.
TARGET="$BUILDKITE_PULL_REQUEST"
if [ "$BUILDKITE_PULL_REQUEST" == "false" ]; then
    TARGET="$BUILDKITE_BRANCH"
fi
TARGET="${TARGET//\//_}"
echo "\$TARGET=$TARGET"

# For nightly builds instead of the build number print nightly and the date.
BUILD="build-${BUILDKITE_BUILD_NUMBER}"
[ -n "$NIGHTLY" ] && BUILD=nightly-"$(date +%s)"
echo "\$BUILD=$BUILD"

ARTIFACTS="buildkite.${BUILDKITE_ORGANIZATION_SLUG}.${TARGET}.${BUILD}.${BUILDKITE_STEP_KEY}.${BUILDKITE_JOB_ID}"
echo "\$ARTIFACTS=$ARTIFACTS"

ARTIFACTS_DIR="artifacts"
echo "\$ARTIFACTS_DIR=$ARTIFACTS_DIR"

function save {
	if [ -d "$1" ]; then
		echo Found artifacts: "$1"
		find "$1"
		cp -R "$1" "$ARTIFACTS_DIR/$ARTIFACTS"
	fi
}

set -x
mkdir -p "$ARTIFACTS_DIR/$ARTIFACTS" artifacts.out
set +x

save "bazel-testlogs"
save "logs"
save "traces"
save "gen"
save "gen-cache"
save "accept_artifacts"

set -x
tar chaf "artifacts.out/$ARTIFACTS.tar.gz" -C "$ARTIFACTS_DIR" "$ARTIFACTS"
set +x
