name: Verify the specified codebase

on:
  push: # run this workflow on every push
  pull_request: # run this workflow on every pull_request

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    env:
      statsFile: '/gobra/stats.json'
    steps:
      - name: Checkout the SCION repository
        uses: actions/checkout@v6
      - name: Set-up caching for the verification results
        uses: actions/cache@v5
        env:
          cache-name: gobra-cache
        with:
          path: ${{ runner.workspace }}/.gobra/cache.json
          key: ${{ env.cache-name }}
      - name: Verify the specified files
        uses: viperproject/gobra-action@v25.09.1
        with:
          # Prefix used to resolve SCION packages
          module: 'github.com/scionproto/scion/'
          # Gobra only verifies files annotated with the header "// +gobra"
          headerOnly: '1'
          # Traverse the entire repository, including nested packages,
          # in search for annotated files to verify
          recursive: '1'
          timeout: 10m
          caching: '1'
          # Explicitly set to preserve previous behavior; the default
          # changed from VSWITHSILICON to SILICON in gobra-action v25.09.
          viperBackend: 'VSWITHSILICON'
          # Work around JDK cgroup v2 NullPointerException on GitHub Actions
          # runners by disabling container support detection. The extra flag
          # is injected via javaXss because the action has no dedicated input
          # for arbitrary JVM flags.
          javaXss: '128m -XX:-UseContainerSupport'
          statsFile: ${{ env.statsFile }}
      - name: Upload the verification report
        uses: actions/upload-artifact@v6
        with:
          name: verification_stats.json
          path: ${{ env.statsFile }}
