version: 2

workflows:
    version: 2
    build_and_test:
        jobs:
            - build
    push_images:
        jobs:
            - publish:
                filters:
                    tags:
                        only: /^v.*/
                    branches:
                        ignore: /.*/

jobs:
    build:
        machine: true
        steps:
            # Setup
            - checkout
            - run:
                name: Pull and tag scion_base image
                command: ./tools/ci/prepare_image fc1d63f0870b97f9b2a2aeef3c8051bf371b8f5767434157d50f3742fe76e2c6
            - run:
                name: Build scion:latest image
                command: ./docker.sh build

            # Build and run tests:
            - run:
                name: Create and start container
                command: ./tools/ci/setup_container
            - run:
                name: Build
                command: ./tools/ci/build
            - run:
                name: Lint
                command: ./tools/ci/lint
            - run:
                name: Unit tests & Coverage
                command: ./tools/ci/test
            - run:
                name: Python documentation (sphinx)
                command: ./tools/ci/sphinx
            - run:
                name: Integration tests
                command: ./tools/ci/integration
            
            # Clean up
            - run:
                name: Gather logs and stop container
                command: |
                    set +e -x
                    TARGET="${CIRCLE_PR_NUMBER:-$CIRCLE_BRANCH}"
                    TARGET="${TARGET//\//_}"
                    REPO="${CIRCLE_PROJECT_REPONAME:-local}"
                    BUILD=$(date +%s)
                    [ -n "$CIRCLE_BUILD_NUM" ] && BUILD="build${CIRCLE_BUILD_NUM}"
                    ARTIFACTS="circleci.${CIRCLE_PROJECT_USERNAME}.${REPO}.${TARGET}.${BUILD}"
                    mkdir -p "/tmp/artifacts/$ARTIFACTS" "/tmp/artifacts.out"
                    ./tools/ci/clean_up /tmp/artifacts/$ARTIFACTS
                    tar caf "/tmp/artifacts.out/$ARTIFACTS.tar.gz" -C /tmp/artifacts "$ARTIFACTS"
                when: always
            - store_artifacts:
                path: /tmp/artifacts.out
                destination: /

    publish:
        machine: true
        steps:
            - checkout
            - run:
                name: Docker upgrade
                command: sudo apt-get update && sudo apt-get install --only-upgrade docker-ce
            - run:
                name: Build base
                command: ./docker.sh base
            - run:
                name: Build image
                command: ./docker.sh build
            - run:
                name: Build app images
                command: make -C docker/perapp
            - run:
                name: Push images
                command: ./docker/perapp/publish "$CIRCLE_TAG"

# vim: expandtab:sw=4:sts=4
