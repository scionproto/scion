steps:
  - label: ":bazel: Build scion code"
    command:
      - bazel --bazelrc=.bazelrc_ci build //:scion //:scion-ci
    key: build
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
        - exit_status: 255 # Forced agent shutdown
    timeout_in_minutes: 10
  - label: ":bazel: Go tests"
    command:
      - bazel --bazelrc=.bazelrc_ci test //go/... --print_relative_test_log_paths
    key: go_tests
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
        - exit_status: 255 # Forced agent shutdown
    timeout_in_minutes: 10
  - label: "Check generated go_deps.bzl file is up to date with go.mod"
    command:
      - "rm -rf /tmp/$BUILDKITE_STEP_ID/"
      - "mkdir -p /tmp/$BUILDKITE_STEP_ID/"
      - "cp go.mod go.sum go_deps.bzl /tmp/$BUILDKITE_STEP_ID/"
      - "make godeps -B"
      - "bazel-${BUILDKITE_PIPELINE_SLUG}/external/go_sdk/bin/go mod tidy"
      - "diff -u /tmp/$BUILDKITE_STEP_ID/go.mod go.mod"
      - "diff -u /tmp/$BUILDKITE_STEP_ID/go.sum go.sum"
      - "diff -u /tmp/$BUILDKITE_STEP_ID/go_deps.bzl go_deps.bzl"
    key: go_deps_lint
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Check generated go/proto files in git"
    command:
      - "rm -rf /tmp/$BUILDKITE_STEP_ID/"
      - "mkdir -p /tmp/$BUILDKITE_STEP_ID/"
      - "cp -R go/proto/ /tmp/$BUILDKITE_STEP_ID/"
      - "make gogen"
      - "diff -ur /tmp/$BUILDKITE_STEP_ID/proto/ go/proto/"
    key: go_gen_lint
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Lint :bazel:"
    command: ./scion.sh lint
    key: lint
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: sig_short_exp_time"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun sig_short_exp_time
    key: sig_short_exp_time_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_child"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_child
    key: br_child_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_core_childIf"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_core_childIf
    key: br_core_childIf_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_core_coreIf"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_core_coreIf
    key: br_core_coreIf_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_core_multi"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_core_multi
    key: br_core_multi_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_multi"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_multi
    key: br_multi_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_parent"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_parent
    key: br_parent_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: br_peer"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun br_peer
    key: br_peer_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: bs_add_link"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun bs_add_link
    key: bs_add_link_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: discovery_br_fetches_dynamic"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun discovery_br_fetches_dynamic
    key: discovery_br_fetches_dynamic_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: discovery_br_fetches_static"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun discovery_br_fetches_static
    key: discovery_br_fetches_static_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: discovery_infra_fetches_dynamic"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun discovery_infra_fetches_dynamic
    key: discovery_infra_fetches_dynamic_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: discovery_infra_fetches_static"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun discovery_infra_fetches_static
    key: discovery_infra_fetches_static_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: reconnecting"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun reconnecting
    key: reconnecting_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: showpaths_status"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun showpaths_status
    key: showpaths_status_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: sig_failover"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun sig_failover
    key: sig_failover_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: sig_reload"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun sig_reload
    key: sig_reload_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_br_reload_if_ip"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_br_reload_if_ip
    key: topo_br_reload_if_ip_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_br_reload_if_port"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_br_reload_if_port
    key: topo_br_reload_if_port_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_br_reload_rollback"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_br_reload_rollback
    key: topo_br_reload_rollback_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_invalid_reloads"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_invalid_reloads
    key: topo_invalid_reloads_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_ps_reloads_br"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_ps_reloads_br
    key: topo_ps_reloads_br_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_sd_reloads_br"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_sd_reloads_br
    key: topo_sd_reloads_br_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
  - label: "Acceptance: topo_sd_reloads_ps"
    command:
      - "rm -rf $$ACCEPTANCE_ARTIFACTS"
      - "mkdir -p $$ACCEPTANCE_ARTIFACTS"
      - ./acceptance/ctl gsetup
      - ./acceptance/ctl grun topo_sd_reloads_ps
    key: topo_sd_reloads_ps_acceptance
    env:
      ACCEPTANCE_ARTIFACTS: "$BUILDKITE_BUILD_CHECKOUT_PATH/accept_artifacts"
      PYTHONPATH: "python/:."
    artifact_paths:
      - "artifacts.out/**/*"
    retry:
      automatic:
        - exit_status: -1 # Agent was lost
        - exit_status: 255 # Forced agent shutdown
