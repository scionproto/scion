#!/bin/bash

. tools/ci/common.sh

if [ -n "$DOCKER_BE" ]; then
    # Stop a local scion run because we don't want to interfere
    ./scion.sh stop
    echo "Stop local zookeeper"
    systemctl is-active --quiet zookeeper && { sudo -p "Stopping local zookeeper: " service zookeeper stop || exit 1; }
fi

./docker.sh build || exit 1
[ -n "$DOCKER_BE" ] && { make -sC docker/perapp || exit 1; }

tmpdir=$(mktemp -d /tmp/artifacts.XXXXXXX)
SCION_MOUNT="$tmpdir" ./docker.sh start || exit 1

result=0
./tools/ci/build
result=$((result+$?))
./tools/ci/lint
result=$((result+$?))
./tools/ci/unittest
result=$((result+$?))
./tools/ci/sphinx
result=$((result+$?))

./tools/ci/integration_setup $DOCKER_BE && ./tools/ci/integration_run -a $DOCKER_BE
result=$((result+$?))

echo "Artifacts dir: $tmpdir"

[ $result -eq 0 ] && ./docker.sh stop

if [ $result -eq 0 ]; then
    echo "All tests successful"
else
    echo "$result tests failed"
fi
exit $result
