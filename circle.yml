machine:
    python:
        version: 3.4.3
    services:
        - docker
    environment:
      BASE_DIR: $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
      ARTIFACTS: circleci.${CIRCLE_PROJECT_REPONAME}.${CIRCLE_PR_NUMBER:-$CIRCLE_BRANCH}.build${CIRCLE_BUILD_NUM}

general:
  build_dir:
    ../../../$BASE_DIR

checkout:
    post:
      - mkdir -p $(dirname $BASE_DIR) && ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $BASE_DIR:
          pwd: /
      - echo 'export GOPATH=$GOPATH:$HOME/.go_project' >> ~/.circlerc
      - git submodule sync
      - git submodule update --init sub/lwip sub/lwip-contrib/

dependencies:
    cache_directories:
        - "~/cache"
    override:
        - go get -d -v ./go/...
        - docker/cache.sh restore
        - mv ~/cache ~/cache.old; mkdir ~/cache
        - ./docker.sh build
        - docker/cache.sh save

test:
    override:
        - ./docker.sh run -c "./scion.sh coverage -v"
        - ./docker.sh run -c "./scion.sh lint"
        - ./docker.sh run -c "make -f sphinx-doc/Makefile clean html"
        - ./docker.sh run -c "docker/integration_test.sh"
    post:
        - mkdir "$ARTIFACTS"
        - mv htmlcov "$ARTIFACTS"/coverage
        - mv sphinx-doc/_build/html/ "$ARTIFACTS"/docs
        - mv logs "$ARTIFACTS"/
        - docker run --privileged scion -c "tar -cf - gen" | tar -xf - -C "$ARTIFACTS"/
        - tar czf "${CIRCLE_ARTIFACTS}/${ARTIFACTS}.tar.gz" "${ARTIFACTS}"
