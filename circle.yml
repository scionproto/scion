machine:
    python:
        version: 3.4.3
    services:
        - docker
    environment:
      BASE_DIR: $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME

general:
  build_dir:
    ../../../$BASE_DIR

checkout:
    post:
      - mkdir -p $(dirname $BASE_DIR) && ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $BASE_DIR:
          pwd: /
      - echo 'export GOPATH=$GOPATH:$HOME/.go_project' >> ~/.circlerc
      - git submodule sync
      - git submodule update --init

dependencies:
    cache_directories:
        - "~/cache"
    override:
        - go get -d -v ./go/...
        - docker/cache.sh restore
        - mv ~/cache ~/cache.old; mkdir ~/cache
        - ./docker.sh build
        - docker/cache.sh save

test:
    override:
        - ./docker.sh run -c "./scion.sh coverage -v"
        - ./docker.sh run -c "./scion.sh lint"
        - ./docker.sh run -c "make -f sphinx-doc/Makefile clean html"
        - ./docker.sh run -c "docker/integration_test.sh"
    post:
        - mkdir artifacts
        - mv htmlcov artifacts/coverage
        - [ -e core ] && mv core artifacts/
        - mv sphinx-doc/_build/html/sphinx-doc/ artifacts/docs
        - mv logs artifacts/logs
        - mv gen artifacts/gen
        - tar czf "${CIRCLE_ARTIFACTS}/circleci.pr${CIRCLE_PR_NUMBER}.build${CIRCLE_BUILD_NUM}.tar.gz" -C artifacts .
