# This docker compose file defines the setup described in
# https://docs.scion.org/en/latest/tutorials/deploy.html
name: "scion-tutorial"

services:
  scion01:
    image: scion01:1.0
    container_name: scion01
    hostname: scion01
    networks:
      as_net_01: {}
      transit_net:
        ipv4_address: 10.100.0.11
    tmpfs:
      - /run
      - /run/lock
  scion02:
    image: scion02:1.0
    container_name: scion02
    hostname: scion02
    networks:
      as_net_02: {}
      transit_net:
        ipv4_address: 10.100.0.12
    tmpfs:
      - /run
      - /run/lock
  scion03:
    image: scion03:1.0
    container_name: scion03
    hostname: scion03
    networks:
      as_net_03: {}
      transit_net:
        ipv4_address: 10.100.0.13
    tmpfs:
      - /run
      - /run/lock
  scion04:
    image: scion04:1.0
    container_name: scion04
    hostname: scion04
    networks:
      as_net_04: {}
      transit_net:
        ipv4_address: 10.100.0.14
    tmpfs:
      - /run
      - /run/lock
  scion05:
    image: scion05:1.0
    container_name: scion05
    hostname: scion05
    networks:
      as_net_05: {}
      transit_net:
        ipv4_address: 10.100.0.15
    tmpfs:
      - /run
      - /run/lock

  # =============================================================================
  # MONITORING STACK (Optional)
  # =============================================================================
  # Enable with: docker compose --profile monitoring up
  #
  # WARNING: This configuration is for LOCAL DEVELOPMENT ONLY.
  # DO NOT expose these ports to the internet:
  #   - Anonymous access is enabled
  #   - Default passwords are used
  #   - No TLS/authentication configured
  #
  # For production monitoring, see: https://prometheus.io/docs/prometheus/latest/configuration/https/
  #
  # Ports:
  #   9090 - Prometheus web UI and API
  #   3000 - Grafana dashboards (login: admin/admin)
  # =============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: scion-prometheus
    profiles: ["monitoring"]
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      transit_net:
        ipv4_address: 10.100.0.90
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=1h'

  grafana:
    image: grafana/grafana:latest
    container_name: scion-grafana
    profiles: ["monitoring"]
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./monitoring/provisioning:/etc/grafana/provisioning:ro
    networks:
      transit_net:
        ipv4_address: 10.100.0.30

networks:
  as_net_01:
    ipam:
      config:
        - subnet: 10.10.1.0/24
  as_net_02:
    ipam:
      config:
        - subnet: 10.10.2.0/24
  as_net_03:
    ipam:
      config:
        - subnet: 10.10.3.0/24
  as_net_04:
    ipam:
      config:
        - subnet: 10.10.4.0/24
  as_net_05:
    ipam:
      config:
        - subnet: 10.10.5.0/24
  # transit_net simulates a Tier 1 network the ASes are all running within.
  transit_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/24
