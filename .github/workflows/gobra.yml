# This file sets up a workflow that runs Gobra (github.com/viperproject/gobra)
# on selected packages of the SCION implementation. Gobra is a program verifier,
# i.e., it checks that the implementation of each function behaves as expected.
# The expected behaviour of each function is provided as a formal specification
# written in comments above the function signature. When Gobra is not able to
# prove that a function behaves according to its specification, it generates an
# (hopefully) informative error message, which identifies the parts of the code
# where the issues might lie.
# For more information on Gobra and its error messages, check the following:
# - The Gobra Book (WIP): viperproject.github.io/gobra-book/
# - The tutorial: github.com/viperproject/gobra/blob/master/docs/tutorial.md
# The former covers more features of Gobra and contains more up-to-date
# information, but it is still under construction.


name: Verify the specified codebase

on:
  push: # run this workflow on every push
  pull_request: # run this workflow on every pull_request

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    env:
      imageVersion: 'v25.09'
      module: 'github.com/scionproto/scion/'
      includePaths: '. ./gobra/stdlib-specs'
    steps:
      - name: Checkout the SCION repository
        uses: actions/checkout@v2
      - name: Check that the package gobra/utils is well-formed
        uses: viperproject/gobra-action@v25.09.1
        with:
          packages: 'gobra/utils'
          # Gobra only verifies files annotated with the header "// +gobra"
          headerOnly: '1'
          timeout: 2m
          imageVersion: ${{ env.imageVersion }}
          module: ${{ env.module }}
          includePaths: ${{ env.includePaths }}
      - name: Check that specifications of third-party libraries are well-formed
        uses: viperproject/gobra-action@v25.09.1
        with:
          projectLocation: 'scion/gobra/stdlib-specs'
          headerOnly: '1'
          # Check all package specifications in directory stdlib-specs
          recursive: '1'
          timeout: 10m
          imageVersion: ${{ env.imageVersion }}
          module: ${{ env.module }}
          includePaths: '. ../..' # relative to project location
      - name: Verify package `pkg/addr`
        uses: viperproject/gobra-action@v25.09.1
        with:
          packages: 'pkg/addr'
          headerOnly: '1'
          timeout: 2m
          imageVersion: ${{ env.imageVersion }}
          module: ${{ env.module }}
          includePaths: ${{ env.includePaths }}
      - name: Verify package `pkg/slayers/path`
        uses: viperproject/gobra-action@v25.09.1
        with:
          packages: 'pkg/slayers/path'
          headerOnly: '1'
          timeout: 2m
          imageVersion: ${{ env.imageVersion }}
          module: ${{ env.module }}
          includePaths: ${{ env.includePaths }}
